<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BERDLTable Service - Live Demo</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --accent-primary: #0f172a;
            --accent-secondary: #3b82f6;
            --accent-success: #10b981;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            padding: 20px 32px;
            border-bottom: 2px solid var(--accent-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container {
            max-width: 1600px;
            /* Wider for data tables */
            margin: 0 auto;
            padding: 24px;
        }

        /* Metrics Dashboard */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Architecture Diagram Styles */
        .arch-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .arch-node {
            background: white;
            border: 2px solid #3b82f6;
            color: #1e293b;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .arch-arrow {
            margin: 0 10px;
            color: #94a3b8;
            font-weight: bold;
            font-size: 1.2em;
        }

        .arch-label {
            display: block;
            font-size: 0.75em;
            color: #64748b;
            margin-top: 4px;
            font-weight: normal;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin: 4px 0;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }


        /* Controls */
        .controls {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            min-width: 200px;
        }

        label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        select,
        input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            width: 100%;
        }

        button {
            background: var(--accent-primary);
            color: var(--bg-primary);
            font-weight: 600;
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--accent-secondary);
        }

        /* DataTable Customization */
        .dataTables_wrapper {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table.dataTable {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-top: 10px !important;
        }

        table.dataTable thead th {
            border-bottom: 2px solid var(--accent-primary) !important;
            color: var(--text-primary);
            padding: 12px 10px !important;
        }

        table.dataTable tbody td {
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px !important;
        }

        /* Column Filter Inputs */
        .filter-input {
            width: 100%;
            padding: 4px 8px;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-redis {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-sqlite {
            background: rgba(124, 58, 237, 0.2);
            color: #8b5cf6;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>BERDLTable Service <span style="font-weight:400; font-size:1rem; opacity:0.7;">| Dynamic Data Browser</span>
        </h1>
        <div id="connection-status" style="color: var(--accent-success); font-size: 0.9rem;">
            ‚óè Service Online <span style="color:var(--text-secondary); margin-left:10px; font-size:0.8rem;">(Local Disk
                Cache: 1 Day Retention)</span>
        </div>
    </div>

    <div class="container">
        <!-- Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Queries</div>
                <div class="metric-value" id="total-queries">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Rows Scanned</div>
                <div class="metric-value" id="rows-scanned">‚Äî</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Last Response</div>
                <div class="metric-value" id="last-response">‚Äî</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Last Source</div>
                <div class="metric-value" id="last-source">‚Äî</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="pangenome-select">Select Pangenome <span id="pg-status"></span></label>
                <div style="display: flex; gap: 10px;">
                    <select id="pangenome-select" style="flex-grow: 1;">
                        <option value="">Loading...</option>
                    </select>
                    <button class="btn" id="btn-clear-cache" style="background: #ef4444; width: auto; padding: 0 15px;"
                        title="Clear local cache to force re-download">
                        Clear Cache
                    </button>
                </div>
            </div>

            <div class="arch-diagram">
                <div class="arch-node">UI Request<span class="arch-label">Client</span></div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-node">Service Layer<span class="arch-label">Python</span></div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-node" style="border-color: #10b981;">Cache Check<span
                        class="arch-label">/scratch</span></div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-node">SQLite/KBase<span class="arch-label">Data Source</span></div>
            </div>
            <div class="control-group">
                <label>2. Select Table</label>
                <select id="table-select" disabled>
                    <option value="">Select Pangenome first</option>
                </select>
            </div>
            <div class="control-group">
                <label>Berdl Table Object ID</label>
                <input type="text" id="berdl-id" value="76990/ADP1Test">
            </div>
            <div class="control-group">
                <label for="kb-token">KBase Token</label>
                <input type="password" id="kb-token" placeholder="Leave empty to use server default...">
                <small style="color: #666; display: block; margin-top: 5px;">* If empty, uses token from test.cfg on
                    server.</small>
            </div>
            <div class="control-group">
                <label>User ID (Isolation Scope)</label>
                <input type="text" id="user-id" value="demo_user">
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <div style="display: flex;">
                    <button class="btn" id="btn-load">Load Table</button>
                    <button class="btn" id="btn-reset-filters" style="background: #64748b; margin-left: 10px;">Reset
                        Filters</button>
                </div>
            </div>

            <!-- Data Table -->
            <table id="data-table" class="display" style="width:100%">
                <thead></thead>
                <tbody></tbody>
                <tfoot></tfoot>
            </table>
        </div>

        <!-- Libs -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

        <script>
            // State
            let table; // DataTable instance
            let stats = { queries: 0, hits: 0 };
            const mockCache = {}; // Client-side cache for mocks

            $(document).ready(function () {
                fetchPangenomes();

                // Event Listeners

                $('#pangenome-select').change(function () {
                    const pgId = $(this).val();
                    const currentBerdlId = $('#berdl-id').val().trim();

                    // Enforce consistency for Mocks
                    if (pgId === 'mock_pg_1') {
                        if (currentBerdlId.toLowerCase() !== 'mocka') $('#berdl-id').val('');
                    } else if (pgId === 'mock_pg_2') {
                        if (currentBerdlId.toLowerCase() !== 'mockb') $('#berdl-id').val('');
                    } else {
                        // If switching TO a real one FROM a mock input, clear the mock input
                        if (currentBerdlId.toLowerCase() === 'mocka' || currentBerdlId.toLowerCase() === 'mockb') {
                            $('#berdl-id').val('');
                        }
                    }

                    if (pgId) fetchTables(pgId);
                    else {
                        $('#table-select').html('<option>Select Pangenome first</option>').prop('disabled', true);
                    }
                });

                // Refresh pangenomes when ID changes
                $('#berdl-id').change(fetchPangenomes);
                $('#kb-token').change(function () {
                    // Re-fetch if token changes
                    fetchPangenomes();
                });

                $('#user-id').keypress(e => { if (e.which == 13) loadTable(); });
                $('#btn-load').click(loadTable);
                $('#btn-reset-filters').click(resetFilters);
                $('#btn-clear-cache').click(clearCache);
            });

            function resetFilters() {
                // Clear input fields
                $('.filter-input').val('');

                // Clear DataTable filters and reload
                if ($.fn.DataTable.isDataTable('#data-table')) {
                    const table = $('#data-table').DataTable();
                    table.columns().search('').draw();
                }
            }

            async function clearCache() {
                const pgId = $('#pangenome-select').val();
                if (!pgId || pgId === "Select Pangenome first") {
                    alert("Please select a pangenome first.");
                    return;
                }

                // Handle Mock Cache
                if (pgId.startsWith('mock_')) {
                    if (mockCache[pgId]) {
                        delete mockCache[pgId];
                        alert(`Mock cache cleared for ${pgId}. Next load will simulate download.`);
                    } else {
                        alert("Mock cache is already empty.");
                    }
                    return;
                }

                if (!confirm(`Are you sure you want to clear the local cache for ${pgId}? Next load will require download.`)) return;

                const btn = $('#btn-clear-cache');
                const originalText = btn.text();
                btn.text("Clearing...").prop('disabled', true);

                try {
                    const res = await callService('clear_pangenome_cache', { pangenome_id: pgId });
                    // Fix: callService returns the result object directly, not a list
                    alert(res.message || "Cache cleared successfully");
                } catch (e) {
                    alert("Failed to clear cache: " + e);
                } finally {
                    btn.text(originalText).prop('disabled', false);
                }
            }

            async function fetchPangenomes() {
                const berdlId = $('#berdl-id').val().trim();
                const $sel = $('#pangenome-select').empty();

                // Mock Interception
                if (berdlId.toLowerCase() === 'mocka') {
                    $sel.append('<option value="mock_pg_1" selected>Mock Pangenome A (Client-Side)</option>');
                    $sel.trigger('change');
                    return;
                }
                if (berdlId.toLowerCase() === 'mockb') {
                    $sel.append('<option value="mock_pg_2" selected>Mock Pangenome B (Client-Side)</option>');
                    $sel.trigger('change');
                    return;
                }

                try {
                    // Only fetch real if it looks like a real ID
                    if (!berdlId || berdlId.includes('/')) {
                        const res = await callService('list_pangenomes', { berdl_table_id: berdlId });
                        $sel.append('<option value="">-- Select Pangenome --</option>');

                        res.pangenomes.forEach(pg => {
                            const label = `${pg.pangenome_taxonomy} (${pg.pangenome_id})`;
                            $sel.append(`<option value="${pg.pangenome_id}">${label}</option>`);
                        });

                        // Auto-select first real one if available
                        if (res.pangenomes.length > 0) {
                            const firstId = res.pangenomes[0].pangenome_id;
                            $sel.val(firstId).trigger('change');
                        }
                    } else {
                        // Fallback for weird inputs
                        $sel.append('<option value="">Invalid ID format</option>');
                    }

                    // Add Mock Pangenomes for Demo (Always available at bottom)
                    $sel.append('<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>');
                    $sel.append('<option value="mock_pg_1">Mock Pangenome A (Client-Side)</option>');
                    $sel.append('<option value="mock_pg_2">Mock Pangenome B (Client-Side)</option>');

                } catch (err) {
                    console.error("List pangenomes failed", err);
                    $('#connection-status').text("‚óè Service Offline").css('color', '#ef4444');
                    // Even if offline, show mocks
                    $sel.empty().append('<option disabled>Connection Failed</option>');
                    $sel.append('<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>');
                    $sel.append('<option value="mock_pg_1">Mock Pangenome A (Client-Side)</option>');
                    $sel.append('<option value="mock_pg_2">Mock Pangenome B (Client-Side)</option>');
                }
            }

            async function fetchTables(pangenomeId) {
                const $sel = $('#table-select').empty();

                // Static list of standard BERDL tables to enable "Lazy Loading"
                // This prevents triggering a DB download just to list tables.
                const tables = [
                    'Conditions', 'DNA_constructs', 'Experiments', 'Genes',
                    'Measurement_types', 'Measurements', 'Primers', 'Samples',
                    'Strains', 'dgoA_alleles_new', 'dgoA_alleles_old', 'robotic_mt_samples'
                ].sort();

                $sel.append('<option value="">-- Select a Table --</option>');
                tables.forEach(t => {
                    $sel.append(`<option value="${t}">${t}</option>`);
                });
                $sel.prop('disabled', false);
            }

            async function loadTable() {
                const tableName = $('#table-select').val();
                const pangenomeId = $('#pangenome-select').val();
                const userId = $('#user-id').val();

                if (!pangenomeId) return alert("Select a pangenome first");
                if (!tableName) return alert("Select a table first");

                // Destroy existing table
                if ($.fn.DataTable.isDataTable('#data-table')) {
                    $('#data-table').DataTable().destroy();
                    $('#data-table').empty(); // Clear DOM
                }

                // Fetch first page to get headers
                try {
                    // Check for Mock Pangenome
                    if (pangenomeId.startsWith('mock_')) {
                        console.log("Loading mock data...");
                        await loadMockData(tableName);
                        return;
                    }

                    const berdlId = $('#berdl-id').val();
                    const initRes = await callService('get_table_data', {
                        user_id: userId,
                        berdl_table_id: berdlId,
                        pangenome_id: pangenomeId,
                        table_name: tableName,
                        limit: 1,
                        offset: 0
                    });

                    const headers = initRes.headers;

                    // Build DOM structure for DataTable with filters in header
                    let thead = '<tr>';
                    let filterRow = '<tr class="filter-row">';

                    headers.forEach(h => {
                        thead += `<th>${h}</th>`;
                        filterRow += `<th><input type="text" placeholder="Filter..." class="filter-input" data-col="${h}" onclick="event.stopPropagation()"></th>`;
                    });
                    thead += '</tr>';
                    filterRow += '</tr>';

                    $('#data-table').html(`<thead>${thead}${filterRow}</thead><tbody></tbody>`);

                    // Initialize Server-side DataTable
                    table = $('#data-table').DataTable({
                        processing: true,
                        serverSide: true,
                        searching: false, // Disable global search
                        displayLength: 25,
                        ordering: true,
                        orderCellsTop: true, // Important: Sort on top row, ignore filter row
                        ajax: async function (data, callback, settings) {
                            const pageSize = data.length;
                            const offset = data.start;

                            // Sorting
                            let sortCol = null;
                            let sortDir = null;
                            if (data.order && data.order.length > 0) {
                                sortCol = headers[data.order[0].column];
                                sortDir = data.order[0].dir;
                            }

                            // Column Filtering
                            const queryFilters = {};
                            $('.filter-input').each(function () {
                                const val = $(this).val();
                                if (val) queryFilters[$(this).data('col')] = val;
                            });

                            const startTime = performance.now();

                            try {
                                const result = await callService('get_table_data', {
                                    user_id: $('#user-id').val(),
                                    berdl_table_id: $('#berdl-id').val(),
                                    pangenome_id: pangenomeId, // Pass Selected Pangenome
                                    table_name: tableName,
                                    limit: pageSize,
                                    offset: offset,
                                    sort_column: sortCol,
                                    sort_order: sortDir,
                                    query_filters: queryFilters
                                });

                                const elapsed = performance.now() - startTime;
                                updateStats(result, elapsed);

                                // Map array data to objects
                                const pageData = result.data.map(row => {
                                    const obj = {};
                                    headers.forEach((h, i) => obj[h] = row[i] || '');
                                    return Object.values(obj);
                                });

                                callback({
                                    draw: data.draw,
                                    recordsTotal: result.total_count,
                                    recordsFiltered: result.filtered_count,
                                    data: pageData
                                });

                            } catch (e) {
                                console.error("Data load error", e);
                            }
                        }
                    });

                    // Bind filter inputs with debounce
                    let debounceTimer;
                    $('.filter-input').on('keyup change', function () {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            table.ajax.reload();
                        }, 300);
                    });

                } catch (err) {
                    const msg = formatError(err);
                    if (msg.includes("Simulated Error")) {
                        alert("‚ö†Ô∏è DEMO SIMULATION: The backend API for this mock pangenome is not connected.");
                    } else {
                        alert("Failed to load table: " + msg);
                    }
                }
            }


            async function callService(method, params) {
                // Using standard JSON-RPC format for KBase services
                const payload = {
                    version: "1.1",
                    method: "BERDLTable_conversion_service." + method,
                    params: [params],
                    id: String(Date.now())
                };

                const token = $('#kb-token').val();
                const headers = {};
                if (token) {
                    headers['Authorization'] = token;
                }

                const res = await $.ajax({
                    url: "http://localhost:10001",
                    method: "POST",
                    contentType: "application/json",
                    headers: headers,
                    data: JSON.stringify(payload)
                });

                if (res.error) throw res.error;
                return res.result[0];
            }

            function updateStats(result, clientMs) {
                stats.queries++;

                $('#total-queries').text(stats.queries);
                $('#rows-scanned').text(result.total_count ? result.total_count.toLocaleString() : '0');
                $('#last-response').text(result.response_time_ms.toFixed(1) + 'ms');

                const source = result.source || 'SQLite';
                const badgeClass = 'status-sqlite';
                const icon = 'üíæ';

                $('#last-source').html(`<span class="status-badge ${badgeClass}">${icon} ${source}</span>`);


            }

            function formatError(err) {
                let msg = "Unknown Error";
                if (typeof err === 'string') return err;

                // jqXHR object
                if (err.responseText) {
                    try {
                        const json = JSON.parse(err.responseText);
                        if (json.error) return json.error.message || json.error;
                    } catch (e) { }
                    return err.responseText;
                }

                // Error object
                if (err.message) return err.message;
                if (err.statusText) return err.statusText;

                try { return JSON.stringify(err); } catch (e) { return String(err); }
            }

            // Mock Data Generator
            async function loadMockData(tableName) {
                const headers = ["ID", "Name", "Type", "Source", "Date_Created", "Status"];
                const mockData = [];

                const pgId = $('#pangenome-select').val();
                const btn = $('#btn-load');
                const originalText = btn.text();

                // Simluated logic
                if (!mockCache[pgId]) {
                    // Simulate Download
                    btn.prop('disabled', true).text("Downloading Mock DB...");
                    $('#last-source').text("Downloading...");

                    // 2 second delay
                    await new Promise(r => setTimeout(r, 2000));

                    mockCache[pgId] = true;
                    updateStats({ response_time_ms: 2000, source: 'KBase Workspace (Simulated)', total_count: 100 }, 2000);
                } else {
                    // Cache Hit
                    updateStats({ response_time_ms: 8, source: 'Local Cache (Simulated)', total_count: 100 }, 8);
                }

                btn.prop('disabled', false).text(originalText);

                for (let i = 0; i < 100; i++) {
                    mockData.push([
                        `MOCK-${i + 1}`,
                        `${tableName}_Item_${i + 1}`,
                        "Simulated",
                        "Internal",
                        new Date().toISOString().split('T')[0],
                        i % 2 == 0 ? "Active" : "Archived"
                    ]);
                }

                // Destroy existing table
                if ($.fn.DataTable.isDataTable('#data-table')) {
                    $('#data-table').DataTable().destroy();
                    $('#data-table').empty();
                }

                let thead = '<tr>';
                let filterRow = '<tr class="filter-row">';
                headers.forEach(h => {
                    thead += `<th>${h}</th>`;
                    filterRow += `<th><input type="text" placeholder="Filter..." class="filter-input" data-col="${h}" onclick="event.stopPropagation()"></th>`;
                });
                thead += '</tr>';
                filterRow += '</tr>';
                $('#data-table').html(`<thead>${thead}${filterRow}</thead><tbody></tbody>`);

                table = $('#data-table').DataTable({
                    data: mockData,
                    searching: true, // Enable client side search for mocks
                    lengthMenu: [10, 25, 50],
                    orderCellsTop: true
                });

                // Bind client-side filters
                $('.filter-input').on('keyup change', function () {
                    const colIdx = headers.indexOf($(this).data('col'));
                    if (colIdx > -1) {
                        table.column(colIdx).search(this.value).draw();
                    }
                });
            }
        </script>
</body>

</html>